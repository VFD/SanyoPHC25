<!DOCTYPE html>
<html lang="fr">
<!--  -->
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="description" content="Hexa editor">
	<meta name="author" content="VincentD">
	<meta name="robots" content="index, follow">
	<title>Hexadecimal Editor</title>
<!--  -->
<style>
body {
  font-family: monospace;
  background-color: #f4f4f4;
  padding: 20px;
}
h1 {
  font-size: 1.75em;
  text-align: center;
}
#output {
  white-space: pre;
  background-color: #fff;
  padding: 10px;
  border: 1px solid #ccc;
  overflow-x: auto;
  max-height: 70vh;
}
.line {
  display: flex;
  margin-bottom: 2px;
}
.offset {
  width: 60px;
  color: #888;
  margin-right: 10px;
}
.hex, .ascii {
  display: flex;
  gap: 4px;
}
.hex {
  margin-right: 20px;
}
.hex input, .ascii input {
  width: 30px;
  text-align: center;
  font-family: monospace;
  border: 1px solid #ccc;
  background-color: #fff;
}
.highlight {
  background-color: #cce5ff;
  border-color: #66afe9 !important;
}
.highlight-offset {
  background-color: #d0f0ff;
  color: #000;
  font-weight: bold;
}
#saveBtn {
  margin-top: 20px;
  padding: 8px 16px;
  font-size: 1em;
}
</style>
<!--  -->
</head>
<!--  -->
<body>
	<!--  -->
	<header>
		<h1>Hexadecimal Editor</h1>
	</header>
	<hr />
	<!--  -->
	<main>
		<input type="file" id="fileInput">
		<div id="output"></div>
		<button id="saveBtn">Save file</button>
	<main>
	<hr />
	<!--  -->
	<footer>
		<p>footer</p>
	</footer>
<!--  -->
<script>
let originalBuffer = [];

document.getElementById('fileInput').addEventListener('change', function(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
	const buffer = new Uint8Array(e.target.result);
	originalBuffer = buffer;
	const output = document.getElementById('output');
	output.innerHTML = '';

	for (let i = 0; i < buffer.length; i += 16) {
	  const line = document.createElement('div');
	  line.className = 'line';
	  line.dataset.offset = i;

	  const offset = document.createElement('div');
	  offset.className = 'offset';
	  offset.textContent = i.toString(16).padStart(6, '0');
	  offset.dataset.offset = i;

	  const hexDiv = document.createElement('div');
	  hexDiv.className = 'hex';

	  const asciiDiv = document.createElement('div');
	  asciiDiv.className = 'ascii';

	  for (let j = 0; j < 16; j++) {
		const index = i + j;
		const byte = buffer[index];

		const hexInput = document.createElement('input');
		hexInput.maxLength = 2;
		hexInput.value = byte !== undefined ? byte.toString(16).padStart(2, '0') : '';
		hexInput.dataset.index = index;
		hexInput.dataset.offset = i;
		hexDiv.appendChild(hexInput);

		const asciiInput = document.createElement('input');
		asciiInput.maxLength = 1;
		asciiInput.value = byte !== undefined && byte >= 32 && byte <= 126 ? String.fromCharCode(byte) : '.';
		asciiInput.dataset.index = index;
		asciiInput.dataset.offset = i;
		asciiDiv.appendChild(asciiInput);

		// Highlight on focus
		hexInput.addEventListener('focus', () => highlight(index, i));
		asciiInput.addEventListener('focus', () => highlight(index, i));

		// Auto-tab hex
		hexInput.addEventListener('input', () => {
		  if (hexInput.value.length === 2) {
			const next = document.querySelector(`input[data-index="${index + 1}"]`);
			if (next) {
			  next.focus();
			  next.select();
			}
		  }
		  const val = parseInt(hexInput.value, 16);
		  const asciiChar = document.querySelector(`.ascii input[data-index="${index}"]`);
		  if (asciiChar) {
			asciiChar.value = (val >= 32 && val <= 126) ? String.fromCharCode(val) : '.';
		  }
		});

		// Auto-tab ASCII
		asciiInput.addEventListener('input', () => {
		  const char = asciiInput.value.charCodeAt(0);
		  const hexField = document.querySelector(`.hex input[data-index="${index}"]`);
		  if (hexField) {
			hexField.value = char.toString(16).padStart(2, '0');
		  }
		  const next = document.querySelector(`.ascii input[data-index="${index + 1}"]`);
		  if (next) {
			next.focus();
			next.select();
		  }
		});
	  }

	  line.appendChild(offset);
	  line.appendChild(hexDiv);
	  line.appendChild(asciiDiv);
	  output.appendChild(line);
	}
  };
  reader.readAsArrayBuffer(file);
});

function highlight(index, offset) {
  document.querySelectorAll('.highlight').forEach(el => el.classList.remove('highlight'));
  document.querySelectorAll('.highlight-offset').forEach(el => el.classList.remove('highlight-offset'));

  const hex = document.querySelector(`.hex input[data-index="${index}"]`);
  const ascii = document.querySelector(`.ascii input[data-index="${index}"]`);
  const offsetEl = document.querySelector(`.offset[data-offset="${offset}"]`);

  if (hex) hex.classList.add('highlight');
  if (ascii) ascii.classList.add('highlight');
  if (offsetEl) offsetEl.classList.add('highlight-offset');
}

document.getElementById('saveBtn').addEventListener('click', function() {
  const hexInputs = document.querySelectorAll('.hex input');
  const newBuffer = new Uint8Array(originalBuffer.length);

  hexInputs.forEach(input => {
	const index = parseInt(input.dataset.index);
	const value = parseInt(input.value, 16);
	newBuffer[index] = isNaN(value) ? 0 : value;
  });

  const blob = new Blob([newBuffer], { type: 'application/octet-stream' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'fichier_modifi√©.bin';
  a.click();
  URL.revokeObjectURL(url);
});
</script>

</body>
</html>
